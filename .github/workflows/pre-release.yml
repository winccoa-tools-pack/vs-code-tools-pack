name: Pre-Release (Release Branch)

on:
    workflow_run:
        workflows:
            - "CI/CD Pipeline"
            - "Integration Tests - WinCC OA"
        types:
            - completed
        branches:
            - release/**
    workflow_dispatch:
        inputs: {}

permissions:
    contents: write
    pull-requests: write
    packages: write
    actions: write
    checks: write
    issues: write
    # Need to bypass branch protection for automated version commits
    # This requires repository admin access or using a PAT

jobs:
    pre-release:
        # Only run if the triggering workflow succeeded
        if: |
            github.event_name == 'workflow_dispatch' ||
            github.event.workflow_run.conclusion == 'success'
        uses: ./.github/workflows/prerelease-reusable.yml
        with:
            target_branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
        secrets: inherit

    notify-success:
        runs-on: ubuntu-latest
        needs: [pre-release]
        if: success()

        steps:
            - name: Success Notification
              run: |
                  echo "ğŸ§ª Pre-release ${{ needs.pre-release.outputs.tag }} created successfully!"
                  echo "ğŸ“¦ Tested VSIX attached to the GitHub pre-release"
                  echo "ğŸ” Available for testing and validation"
                  echo "ğŸ“ Auto-generated from release branch"
                  echo ""
                  echo "ğŸ”— Pre-release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.pre-release.outputs.tag }}"
                  echo ""
                  echo "ğŸ§ª Test the pre-release and provide feedback!"
