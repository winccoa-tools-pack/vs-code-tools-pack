name: CI/CD Pipeline

on:
  push:
    branches: [develop, release/**]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-extension-pack:
    runs-on: ubuntu-latest
    outputs:
      is_extension_pack: ${{ steps.detect.outputs.is_extension_pack }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect Extension Pack
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f package.json ]; then
            echo "is_extension_pack=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IS_EP=$(node -e "const p=require('./package.json'); const c=p.categories||[]; process.stdout.write(String(Array.isArray(c)&&c.includes('Extension Packs')));")
          echo "is_extension_pack=$IS_EP" >> "$GITHUB_OUTPUT"

  lint:
    needs: [detect-extension-pack]
    if: ${{ needs.detect-extension-pack.outputs.is_extension_pack != 'true' }}
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci
      - name: Run linting
        run: npm run lint && npm run lint:md

  format:
    needs: [detect-extension-pack]
    if: ${{ needs.detect-extension-pack.outputs.is_extension_pack != 'true' }}
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run format check
        run: npm run format:check

  test:
    needs: [detect-extension-pack, format, lint]
    if: ${{ needs.detect-extension-pack.outputs.is_extension_pack != 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [20.x, 22.x, 24.x, 25.x]


    env:
      CI: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile
        run: npm run compile

      # If your tests use @vscode/test-electron, Linux needs xvfb
      - name: Run tests (Linux headless)
        if: startsWith(matrix.os, 'ubuntu')
        run: xvfb-run -a npm run test:unit
        env:
          CI: true

      - name: Run tests (non-Linux)
        if: ${{ !startsWith(matrix.os, 'ubuntu') }}
        run: npm run test:unit
        env:
          CI: true

  integration-winccoa:
    needs: [detect-extension-pack, test]
    if: ${{ needs.detect-extension-pack.outputs.is_extension_pack != 'true' && needs.test.result == 'success' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        image:
          - mpokornyetm/winccoa-tools-pack-vscode-winccoa-tests:winccoa-3.19.9-node20-vscode-winccoa-tests

    env:
      WORKDIR: /workspace
      IMAGE: ${{ matrix.image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        shell: bash
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -n "${DOCKER_USER:-}" ] && [ -n "${DOCKER_PASSWORD:-}" ]; then
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
          else
            echo "Docker credentials not available, attempting to pull public image"
          fi

      - name: Pull WinCC OA image
        shell: bash
        run: docker pull "$IMAGE"

      - name: Run WinCC OA container
        shell: bash
        run: |
          set -euo pipefail
          docker run -d --name winccoa-ci \
            -v "$GITHUB_WORKSPACE":$WORKDIR:rw \
            -e CI=true \
            -w $WORKDIR \
            "$IMAGE" tail -f /dev/null

      - name: Show Node on runner
        shell: bash
        run: node -v || true

      - name: Wait for WinCC OA readiness
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for WinCC OA inside container..."
          for i in {1..60}; do
            if docker exec winccoa-ci sh -c '[ -x /opt/WinCC_OA/bin/winccoa ]'; then
              echo "Container ready (attempt $i)";
              break;
            fi
            sleep 2
          done

      - name: Run integration tests inside container
        shell: bash
        run: |
          set -euo pipefail
          docker exec --user root winccoa-ci sh -c '
            set -e
            echo "Node version: $(node -v)"
            echo "Starting integration tests under Xvfb"
            xvfb-run -s "-screen 0 1280x1024x24" npm run ci:integration
          '

      - name: Collect logs on failure
        if: failure()
        shell: bash
        run: |
          echo "==== docker logs ===="
          docker logs winccoa-ci || true

      - name: Stop and remove container
        if: always()
        shell: bash
        run: |
          docker rm -f winccoa-ci || true

  required:
    name: Required
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs:
      - detect-extension-pack
      - lint
      - format
      - test
      - integration-winccoa
    steps:
      - name: Verify required jobs
        shell: bash
        run: |
          set -euo pipefail

          # Treat skipped as OK (e.g. extension pack repos)
          RESULTS=(
            "detect-extension-pack:${{ needs.detect-extension-pack.result }}"
            "lint:${{ needs.lint.result }}"
            "format:${{ needs.format.result }}"
            "test:${{ needs.test.result }}"
            "integration-winccoa:${{ needs.integration-winccoa.result }}"
          )

          echo "Job results:"
          printf ' - %s\n' "${RESULTS[@]}"

          FAIL=0
          for r in "${RESULTS[@]}"; do
            status="${r#*:}"
            case "$status" in
              success|skipped)
                ;;
              *)
                echo "::error::Required job did not succeed: $r"
                FAIL=1
                ;;
            esac
          done

          if [ "$FAIL" -ne 0 ]; then
            exit 1
          fi
