name: Pre-Release (Develop)

on:
  workflow_run:
    workflows:
      - "CI/CD Pipeline"
    types:
      - completed
    branches:
      - develop
  workflow_dispatch:
    inputs: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  pre-release:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    uses: ./.github/workflows/prerelease-reusable.yml
    with:
      target_branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
      validate_release_branch: false
    secrets: inherit

  cleanup-old-prereleases:
    runs-on: ubuntu-latest
    needs: [pre-release]
    if: always() && needs.pre-release.result == 'success'

    permissions:
      contents: write

    env:
      TARGET_BRANCH: ${{ github.event.workflow_run.head_branch || github.ref_name }}
      KEEP_LATEST: "5"
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Remove older prereleases for this branch
        shell: bash
        run: |
          set -euo pipefail

          echo "üßπ Cleaning prereleases for branch: ${TARGET_BRANCH} (keep latest ${KEEP_LATEST})"

          # List prereleases newest-first.
          mapfile -t ALL_TAGS < <(
            gh release list --limit 200 --json tagName,isPrerelease,createdAt \
              --jq '[.[] | select(.isPrerelease == true)] | sort_by(.createdAt) | reverse | .[].tagName'
          )

          if [ ${#ALL_TAGS[@]} -eq 0 ]; then
            echo "‚úÖ No prereleases found"
            exit 0
          fi

          MATCHED=()
          for TAG in "${ALL_TAGS[@]}"; do
            BODY=$(gh release view "$TAG" --json body --jq '.body' 2>/dev/null || true)
            if echo "$BODY" | grep -q "Source branch: ${TARGET_BRANCH}"; then
              MATCHED+=("$TAG")
            fi
          done

          if [ ${#MATCHED[@]} -le ${KEEP_LATEST} ]; then
            echo "‚úÖ Nothing to delete (matched ${#MATCHED[@]} prereleases)"
            exit 0
          fi

          echo "Found ${#MATCHED[@]} prereleases for '${TARGET_BRANCH}':"
          printf '  - %s\n' "${MATCHED[@]}"

          TO_DELETE=("${MATCHED[@]:${KEEP_LATEST}}")
          echo "Deleting ${#TO_DELETE[@]} older prereleases:"
          printf '  - %s\n' "${TO_DELETE[@]}"

          for TAG in "${TO_DELETE[@]}"; do
            gh release delete "$TAG" --yes --cleanup-tag || echo "::warning::Failed to delete $TAG"
          done

  notify-success:
    runs-on: ubuntu-latest
    needs: [pre-release, cleanup-old-prereleases]
    if: success()

    steps:
      - name: Success Notification
        run: |
          echo "üß™ Dev pre-release ${{ needs.pre-release.outputs.tag }} created successfully!"
          echo "üì¶ VSIX attached to the GitHub pre-release"
          echo "üìù Auto-generated from develop"
          echo ""
          echo "üîó Pre-release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.pre-release.outputs.tag }}"
