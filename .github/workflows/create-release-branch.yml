name: Create Release Branch + PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (SemVer, e.g. 1.2.3)"
        required: true
        type: string
      base_branch:
        description: "Base branch (typically develop)"
        required: true
        default: "develop"
        type: string
      target_branch:
        description: "PR target branch (typically main)"
        required: true
        default: "main"
        type: string
      draft:
        description: "Create PR as draft"
        required: true
        default: false
        type: boolean
      labels:
        description: "Comma-separated labels to apply (optional)"
        required: false
        default: "chore,release"
        type: string

concurrency:
  group: create-release-branch-${{ github.repository }}-${{ github.event.inputs.version }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Create release branch and PR
        id: create
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.REPO_ADMIN_TOKEN != '' && secrets.REPO_ADMIN_TOKEN || github.token }}
          script: |
            const rawVersion = (context.payload.inputs?.version || '').trim();
            const version = rawVersion.replace(/^v/i, '');
            const baseBranch = (context.payload.inputs?.base_branch || 'develop').trim();
            const targetBranch = (context.payload.inputs?.target_branch || 'main').trim();
            const draft = String(context.payload.inputs?.draft || 'false').toLowerCase() === 'true';
            const labelsRaw = (context.payload.inputs?.labels || '').trim();
            const labels = labelsRaw
              ? labelsRaw.split(',').map(l => l.trim()).filter(Boolean)
              : [];

            if (!/^\d+\.\d+\.\d+$/.test(version)) {
              core.setFailed(`Invalid version '${rawVersion}'. Expected SemVer like 1.2.3 (optional leading 'v' allowed)`);
              return;
            }

            const releaseBranch = `release/v${version}`;
            core.info(`Base: ${baseBranch}`);
            core.info(`Target: ${targetBranch}`);
            core.info(`Release branch: ${releaseBranch}`);

            // 1) Ensure base branch exists
            let base;
            try {
              base = await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: baseBranch,
              });
            } catch (error) {
              core.setFailed(`Base branch '${baseBranch}' not found (or not accessible).`);
              return;
            }

            // 2) Create release branch if missing
            let branchExists = false;
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: releaseBranch,
              });
              branchExists = true;
              core.info(`Branch already exists: ${releaseBranch}`);
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            if (!branchExists) {
              const sha = base.data.commit.sha;
              core.info(`Creating ${releaseBranch} at ${sha}`);
              try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/heads/${releaseBranch}`,
                  sha,
                });
              } catch (error) {
                const status = error?.status;
                const msg = error?.message || String(error);
                core.setFailed(
                  `Failed to create branch '${releaseBranch}'. This is usually caused by rulesets/branch protections blocking ref creation or missing token permissions. (HTTP ${status ?? 'unknown'}) ${msg}`
                );
                return;
              }
            }

            // 3) Reuse existing open PR if present
            const head = `${context.repo.owner}:${releaseBranch}`;
            const existing = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: targetBranch,
              head,
              per_page: 10,
            });

            if (existing.data.length > 0) {
              const pr = existing.data[0];
              core.info(`PR already exists: ${pr.html_url}`);
              core.setOutput('branch', releaseBranch);
              core.setOutput('pr_url', pr.html_url);
              return;
            }

            // 4) Create PR
            const title = `chore(release): Release v${version}`;
            const body = [
              `Automated release PR for **v${version}**.`,
              '',
              'Checklist:',
              '- [ ] CI passes on this branch',
              '- [ ] Pre-release workflow produced a tested VSIX (GitHub pre-release asset)',
              '- [ ] Manual validation done',
              '- [ ] Merge into main when ready',
              '',
              'Notes:',
              `- Branch: ${releaseBranch}`,
              `- Base: ${baseBranch}`,
              `- Target: ${targetBranch}`,
            ].join('\n');

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: releaseBranch,
              base: targetBranch,
              body,
              draft,
            });

            core.info(`Created PR: ${pr.data.html_url}`);

            // 5) Apply labels if possible
            if (labels.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.data.number,
                  labels,
                });
                core.info(`Applied labels: ${labels.join(', ')}`);
              } catch (error) {
                core.warning(`Could not apply labels (${labels.join(', ')}): ${error.message}`);
              }
            }

            core.setOutput('branch', releaseBranch);
            core.setOutput('pr_url', pr.data.html_url);

      - name: Summary
        run: |
          echo "âœ… Release branch: ${{ steps.create.outputs.branch }}"
          echo "ðŸ”— PR: ${{ steps.create.outputs.pr_url }}"
