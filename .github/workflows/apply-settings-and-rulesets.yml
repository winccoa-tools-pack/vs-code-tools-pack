name: Apply Repo Settings & Rulesets (YAML)

on:
  push:
    paths:
      - ".github/repository.settings.yml"
      - ".github/rulesets/**"
      - ".github/workflows/apply-settings-and-rulesets.yml"
  workflow_dispatch:
    inputs:
      mode:
        description: "dry-run prints payloads; apply updates repo/settings/rulesets"
        required: true
        default: "dry-run"
        type: choice
        options:
          - dry-run
          - apply

permissions:
  contents: read
  actions: read

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set mode
        id: mode
        shell: bash
        run: |
          MODE="dry-run"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          fi
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"
          echo "Mode: $MODE"

      - name: Install Python tooling
        shell: bash
        run: |
          python3 --version
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      - name: Prepare payloads from YAML
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          python3 .github/scripts/generate_settings_payloads.py

          if [ -f .github/repository.settings.yml ]; then
            echo "has_settings=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_settings=false" >> "$GITHUB_OUTPUT"
          fi

          if ls -1 ruleset_payloads/*.json >/dev/null 2>&1; then
            echo "has_rulesets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_rulesets=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dry-run summary
        if: ${{ steps.mode.outputs.mode == 'dry-run' }}
        shell: bash
        run: |
          echo "--- repo_patch.json ---"; cat repo_patch.json; echo
          echo "--- topics.json ---"; cat topics.json; echo
          echo "--- security.json ---"; cat security.json; echo
          echo "--- rulesets ---"; ls -la ruleset_payloads || true

      - name: Authenticate gh
        if: ${{ steps.mode.outputs.mode == 'apply' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN != '' && secrets.REPO_ADMIN_TOKEN || github.token }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
          gh auth status

      - name: Apply repository settings
        if: ${{ steps.mode.outputs.mode == 'apply' && steps.prep.outputs.has_settings == 'true' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN != '' && secrets.REPO_ADMIN_TOKEN || github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          IFS='/' read -r OWNER NAME <<< "$REPO"

          if [ "$(jq 'length' repo_patch.json)" -gt 0 ]; then
            gh api --method PATCH -H "Accept: application/vnd.github+json" \
              "repos/$OWNER/$NAME" --input repo_patch.json
          fi

          if jq -e 'type=="array"' topics.json >/dev/null; then
            jq -n --argfile t topics.json '{names: $t}' > topics_payload.json
            gh api --method PUT -H "Accept: application/vnd.github+json" \
              "repos/$OWNER/$NAME/topics" --input topics_payload.json
          else
            echo "Skipping topics update (not specified)."
          fi

          if jq -e '.enable_vulnerability_alerts==true' security.json >/dev/null; then
            gh api --method PUT -H "Accept: application/vnd.github+json" \
              "repos/$OWNER/$NAME/vulnerability-alerts" || true
          fi
          if jq -e '.enable_automated_security_fixes==true' security.json >/dev/null; then
            gh api --method PUT -H "Accept: application/vnd.github+json" \
              "repos/$OWNER/$NAME/automated-security-fixes" || true
          fi

      - name: Upsert repository rulesets
        if: ${{ steps.mode.outputs.mode == 'apply' && steps.prep.outputs.has_rulesets == 'true' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN != '' && secrets.REPO_ADMIN_TOKEN || github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          IFS='/' read -r OWNER NAME <<< "$REPO"

          gh api -H "Accept: application/vnd.github+json" "repos/$OWNER/$NAME/rulesets" > existing_rulesets.json

          for payload in ruleset_payloads/*.json; do
            RS_NAME=$(jq -r '.name // empty' "$payload")
            if [ -z "$RS_NAME" ]; then
              echo "Skipping $payload (missing .name)"
              continue
            fi

            RS_ID=$(jq -r --arg n "$RS_NAME" '.[] | select(.name==$n) | .id' existing_rulesets.json | head -n 1)
            if [ -n "$RS_ID" ] && [ "$RS_ID" != "null" ]; then
              echo "Updating ruleset: $RS_NAME (id=$RS_ID)"
              gh api --method PUT -H "Accept: application/vnd.github+json" \
                "repos/$OWNER/$NAME/rulesets/$RS_ID" --input "$payload"
            else
              echo "Creating ruleset: $RS_NAME"
              gh api --method POST -H "Accept: application/vnd.github+json" \
                "repos/$OWNER/$NAME/rulesets" --input "$payload"
            fi
          done
